name: å°çº¢ä¹¦å…³é”®è¯æœç´¢çˆ¬è™«

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      query:
        description: 'æœç´¢å…³é”®è¯'
        required: true
        type: string
      num:
        description: 'çˆ¬å–æ•°é‡'
        required: false
        type: number
        default: 10
      sort_type:
        description: 'æ’åºæ–¹å¼ (0-ç»¼åˆæ’åº, 1-æœ€æ–°, 2-æœ€å¤šç‚¹èµ, 3-æœ€å¤šè¯„è®º, 4-æœ€å¤šæ”¶è—)'
        required: false
        type: choice
        options:
        - '0'
        - '1' 
        - '2'
        - '3'
        - '4'
        default: '0'
      cookies:
        description: 'å°çº¢ä¹¦ Cookies'
        required: true
        type: string
      webhook_url:
        description: 'Webhook URL (ç”¨äºæ¥æ”¶çˆ¬å–ç»“æœï¼Œå¯é€‰)'
        required: false
        type: string
      get_comments:
        description: 'æ˜¯å¦è·å–è¯„è®º'
        required: false
        type: boolean
        default: false
      no_delay:
        description: 'æ˜¯å¦ç¦ç”¨éšæœºå»¶è¿Ÿ'
        required: false
        type: boolean
        default: false
  
  # æ”¯æŒAPIè§¦å‘ (repository_dispatch)
  repository_dispatch:
    types: [search-xhs, crawl-task]

jobs:
  search-xhs:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: å®‰è£… uv (PythonåŒ…ç®¡ç†å™¨)
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: å®‰è£… Node.js (for jsdom)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync
        npm install
        
    - name: è§£æå‚æ•°
      id: parse-params
      run: |
        # æ ¹æ®è§¦å‘æ–¹å¼è§£æå‚æ•°
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨ inputs
          echo "query=${{ inputs.query }}" >> $GITHUB_OUTPUT
          echo "num=${{ inputs.num }}" >> $GITHUB_OUTPUT
          echo "sort_type=${{ inputs.sort_type }}" >> $GITHUB_OUTPUT
          echo "cookies=${{ inputs.cookies }}" >> $GITHUB_OUTPUT
          echo "webhook_url=${{ inputs.webhook_url }}" >> $GITHUB_OUTPUT
          echo "get_comments=${{ inputs.get_comments }}" >> $GITHUB_OUTPUT
          echo "no_delay=${{ inputs.no_delay }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          # APIè§¦å‘ï¼Œä½¿ç”¨ client_payload
          echo "query=${{ github.event.client_payload.query }}" >> $GITHUB_OUTPUT
          echo "num=${{ github.event.client_payload.num || 10 }}" >> $GITHUB_OUTPUT
          echo "sort_type=${{ github.event.client_payload.sort_type || 0 }}" >> $GITHUB_OUTPUT
          echo "cookies=${{ github.event.client_payload.cookies }}" >> $GITHUB_OUTPUT
          echo "webhook_url=${{ github.event.client_payload.webhook_url }}" >> $GITHUB_OUTPUT
          echo "get_comments=${{ github.event.client_payload.get_comments || false }}" >> $GITHUB_OUTPUT
          echo "no_delay=${{ github.event.client_payload.no_delay || false }}" >> $GITHUB_OUTPUT
        fi
        
        # ç”Ÿæˆè¿è¡ŒID
        echo "run_id=run_$(date +%Y%m%d_%H%M%S)_${{ github.run_id }}" >> $GITHUB_OUTPUT
        
    - name: æ˜¾ç¤ºå‚æ•°ä¿¡æ¯
      run: |
        echo "ğŸ” æœç´¢å…³é”®è¯: ${{ steps.parse-params.outputs.query }}"
        echo "ğŸ“Š çˆ¬å–æ•°é‡: ${{ steps.parse-params.outputs.num }}"
        echo "ğŸ”€ æ’åºæ–¹å¼: ${{ steps.parse-params.outputs.sort_type }}"
        echo "ğŸ’¬ è·å–è¯„è®º: ${{ steps.parse-params.outputs.get_comments }}"
        echo "â±ï¸ ç¦ç”¨å»¶è¿Ÿ: ${{ steps.parse-params.outputs.no_delay }}"
        echo "ğŸ†” è¿è¡ŒID: ${{ steps.parse-params.outputs.run_id }}"
        echo "ğŸŒ Webhook URL: ${{ steps.parse-params.outputs.webhook_url }}"
        
    - name: è¿è¡Œçˆ¬è™«
      run: |
        # æ„å»ºå‘½ä»¤å‚æ•°
        ARGS="--query '${{ steps.parse-params.outputs.query }}' \
              --num ${{ steps.parse-params.outputs.num }} \
              --sort-type ${{ steps.parse-params.outputs.sort_type }} \
              --cookies '${{ steps.parse-params.outputs.cookies }}' \
              --run-id '${{ steps.parse-params.outputs.run_id }}'"
        
        # æ·»åŠ å¯é€‰çš„ webhook URL
        if [ -n "${{ steps.parse-params.outputs.webhook_url }}" ]; then
          ARGS="$ARGS --webhook-url '${{ steps.parse-params.outputs.webhook_url }}'"
        fi
        
        # æ·»åŠ å¯é€‰å‚æ•°
        if [ "${{ steps.parse-params.outputs.get_comments }}" = "true" ]; then
          ARGS="$ARGS --get-comments"
        fi
        
        if [ "${{ steps.parse-params.outputs.no_delay }}" = "true" ]; then
          ARGS="$ARGS --no-delay"
        fi
        
        # è¿è¡Œçˆ¬è™«
        echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: uv run python action_main.py $ARGS"
        eval "uv run python action_main.py $ARGS"
      env:
        PYTHONPATH: ${{ github.workspace }}
        
    - name: ä¸Šä¼ æ—¥å¿— (å¦‚æœå¤±è´¥)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: spider-logs-${{ steps.parse-params.outputs.run_id }}
        path: logs/
        retention-days: 7 